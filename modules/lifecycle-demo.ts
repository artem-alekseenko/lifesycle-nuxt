import { defineNuxtModule, addPlugin, createResolver } from '@nuxt/kit'

export default defineNuxtModule({
  meta: {
    name: 'lifecycle-demo',
    configKey: 'lifecycleDemo'
  },
  
  defaults: {
    enabled: true,
    logLevel: 'info'
  },
  
  setup(options, nuxt) {
    if (!options.enabled) {
      return
    }

    const resolver = createResolver(import.meta.url)
    
    console.log(`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🟣 [M0] MODULE SETUP — Инициализация модуля lifecycle-demo
   💡 Лёгкие вещи: изменение конфигурации, регистрация хуков
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`)

    // ЛЁГКИЕ ВЕЩИ — делаем прямо в setup()
    // Изменение конфигурации Nuxt
    nuxt.options.runtimeConfig.public.lifecycleDemo = {
      enabled: options.enabled,
      logLevel: options.logLevel,
      moduleVersion: '1.0.0'
    }
    
    // Хук modules:done - когда все модули установлены
    nuxt.hook('modules:done', () => {
      console.log(`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🟣 [M1] MODULE HOOK modules:done — Все модули установлены
   💡 Все модули выполнили свою функцию setup()
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`)
    })
    
    // Хук ready - инстанс Nuxt во время сборки/старта
    // ⚠️ ВАЖНО: блокирует старт/сборку до завершения!
    // Хорошее место для финального редактирования конфига и добавления плагинов
    nuxt.hook('ready', async (nuxt) => {
      console.log(`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🟣 [M2] MODULE HOOK ready — Nuxt готов к использованию
   ⚠️  Блокирует старт/сборку до завершения!
   💡 Финальное редактирование конфига, добавление плагинов
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`)

      // ТЯЖЁЛЫЕ ВЕЩИ (I/O) — делаем аккуратно здесь, чтобы не тормозить
      // Симуляция асинхронной операции (например, чтение файла, запрос к API)
      await new Promise(resolve => setTimeout(resolve, 10))
      
      // Финальное редактирование конфигурации
      nuxt.options.runtimeConfig.public.lifecycleDemo.readyAt = new Date().toISOString()
      
      // Добавление плагинов (всё, что должно жить на запросах/в браузере)
      addPlugin({
        src: resolver.resolve('./runtime/plugin.client'),
        mode: 'client'
      })
      
      // Runtime-плагины для сервера
      addPlugin({
        src: resolver.resolve('./runtime/plugin.server'),
        mode: 'server'
      })

      console.log(`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🟣 [M2] MODULE HOOK ready — Завершено
   ✅ Runtime-плагины добавлены
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`)
    })
    
    // Хук build:done - после завершения сборки
    // В dev — после первичной сборки; не триггерится на каждый HMR
    nuxt.hook('build:done', () => {
      console.log(`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🟣 [M3] MODULE HOOK build:done — Сборка завершена
   💡 В dev — после первичной сборки; не триггерится на каждый HMR
   💡 Можно делать пост-обработку собранных файлов
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`)
    })
    
    // Хук close - при остановке процесса Nuxt (dev-сервер, build-процесс)
    // Удобно для очистки временных файлов/соединений
    nuxt.hook('close', async () => {
      console.log(`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🟣 [M4] MODULE HOOK close — Процесс завершается
   💡 Очистка временных файлов/соединений
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`)

      // Симуляция очистки ресурсов
      await new Promise(resolve => setTimeout(resolve, 5))
      
      console.log(`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🟣 [M4] MODULE HOOK close — Ресурсы очищены
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`)
    })
  }
})


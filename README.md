# Nuxt Minimal Starter

Look at the [Nuxt documentation](https://nuxt.com/docs/getting-started/introduction) to learn more.

## Setup

Make sure to install dependencies:

```bash
# npm
npm install

# pnpm
pnpm install

# yarn
yarn install

# bun
bun install
```

## Development Server

Start the development server on `http://localhost:3000`:

```bash
# npm
npm run dev

# pnpm
pnpm dev

# yarn
yarn dev

# bun
bun run dev
```

## Production

Build the application for production:

```bash
# npm
npm run build

# pnpm
pnpm build

# yarn
yarn build

# bun
bun run build
```

Locally preview production build:

```bash
# npm
npm run preview

# pnpm
pnpm preview

# yarn
yarn preview

# bun
bun run preview
```

Check out the [deployment documentation](https://nuxt.com/docs/getting-started/deployment) for more information.

## Жизненный цикл Nuxt приложения

Этот проект демонстрирует полный жизненный цикл Nuxt приложения с SSR (Server-Side Rendering). В консоли браузера и сервера вы увидите подробные логи каждого этапа с пояснениями.

### Серверные этапы (SSR)

#### S1. Обработка запроса в `server/middleware/log.ts` (Nitro middleware)

**Слой:** Nitro/H3 (сервер)  
**Файл:** `nuxt-app/server/middleware/log.ts`  
**Когда:** на каждый HTTP-запрос; выполняется перед API-роутами и SSR.

**Хуки:** нет.

**Для чего:**
- Ранняя обработка запроса:
  - логирование,
  - CORS (заголовки Access-Control-*),
  - проверка куков/заголовков (аутентификация),
  - добавление служебных данных в `event.context`.
- Можно вернуть `H3Event` или использовать `send()`/`throwError()` для отправки ответа или ошибки, прерывая дальнейшую обработку. Важно учитывать порядок middleware, так как они выполняются последовательно.
- Типичные случаи использования: защита от CSRF, логирование запросов с учетом приватности (маскирование данных).

**Как понять успех/ошибку без логов:**
- **успех:** в Network видишь обычный ответ следующего этапа (обычно 200/3xx/4xx от приложения); если middleware добавляет заголовок — проверь его наличие в ответе;
- **ошибка/ранний выход:** статус/тело сформированы именно здесь (например, 401/403/422), дальше рендера нет; при проблемах с CORS — браузер пометит запрос как CORS-blocked (Preflight/Origin).

**Текст лога:** `[S1] SERVER MIDDLEWARE — Обработка HTTP-запроса (Nitro/H3)`

---

#### S2. Создание Nuxt-приложения и `app:created` в `app/plugins/app.server.ts`

**Слой:** Nuxt (сервер)  
**Файл:** `nuxt-app/app/plugins/app.server.ts`  
**Когда:** на каждый SSR-запрос; после инициализации Nuxt-приложения, в конце этапа вызывается хук `app:created`.

**Хуки:** `app:created` (срабатывает в конце этапа).

**Для чего:**
- Использование `nuxtApp.provide()` создает глобально доступные инъекции. Важно помнить, что на сервере каждый запрос получает новый экземпляр приложения Nuxt, поэтому DI обеспечивает изоляцию данных между запросами.
- Доступ к текущему H3-запросу: `useRequestEvent()` (IP, куки, заголовки) → можно вычислить локаль/UA и положить в `nuxtApp.provide`,
- Инициализация «server-only» зависимостей: секретные SDK/ключи/коннекты к БД, которые нельзя на клиент.
- Рассмотрите использование `@nuxtjs/` сторонних библиотек для централизованного управления состоянием и DI на сервере.

**Как понять успех/ошибку без логов:**
- **успех:** сервер отдаёт страницу (200/3xx/4xx как задумано), а DI доступен в компонентах (`useNuxtApp().$api`);
- **ошибка:** 500 «Internal Server Error» уже на первом заходе; если внутри плагина бросили исключение/промис отклонён — SSR падает ещё до рендера.

**Текст лога:** `[S2] SERVER PLUGIN — Создание Nuxt-приложения и хук app:created`

---

#### S3. Глобальное route-middleware (сервер) в `app/middleware/trace.global.ts`

**Слой:** Nuxt (сервер)  
**Файл:** `nuxt-app/app/middleware/trace.global.ts`  
**Когда:** перед первым SSR-рендером конкретной страницы. (Ещё раз будет в браузере — см. C2.)

**Хуки:** нет.

**Для чего:**
- Проверка и управление маршрутами:
  - авторизация/роли,
  - локализация/префикс языка,
  - канонизация URL (убрать/добавить слэш, привести /index к /),
  - аналитика переходов.
- Функция `navigateTo()` создает редирект. Важно понимать разницу между 301 (постоянный редирект, кэшируется браузером) и 302 (временный редирект). Неправильный выбор может повлиять на SEO и производительность.
- В глобальных middleware можно реализовать сложную логику авторизации, например, проверку JWT и установку пользователя в контекст.

**Как понять успех/ошибку без логов:**
- **успех:** в Network — обычный 200 (рендер продолжился);
- **редирект:** статус 301/302 + заголовок Location (новый URL);
- **запрет:** 401/403/404 (что вы вернёте).

**Текст лога:** `[S3] ROUTE MIDDLEWARE (SERVER) — Проверка маршрута перед SSR-рендером`

---

#### S4. Выполнение на сервере `setup` корневого компонента `app/app.vue`

**Слой:** Nuxt/Vue (сервер)  
**Файл:** `nuxt-app/app/app.vue`  
**Когда:** в начале SSR-рендера дерева компонентов (после S3).

**Хуки:** нет серверных lifecycle-хуков (`onMounted`/`onBeforeMount` не вызываются на сервере).

**Для чего:**
- Глобальная подготовка без DOM:
  - Определение layout с помощью `<NuxtLayout>` или `useLayout()`. Layout оборачивает содержимое страницы и позволяет определить структуру сайта.
  - `provide` значений/сервисов на всё дерево,
  - общая конфигурация страницы.
- Здесь также можно использовать `useHead()` для динамического управления мета-тегами страницы (title, description и т.д.).

**Как понять успех/ошибку без логов:**
- **успех:** SSR продолжается к S5, в результате придёт HTML;
- **ошибка:** 500 на рендере; типичная причина — попытка обратиться к `window`/`document` на сервере.

**Текст лога:** `[S4] APP.VUE SETUP (SERVER) — Выполнение setup корневого компонента`

---

#### S5. Выполнение на сервере `setup` страницы `app/pages/index.vue`

**Слой:** Nuxt/Vue (сервер)  
**Файл:** `nuxt-app/app/pages/index.vue`  
**Когда:** после S4; здесь же выполняются асинхронные загрузки данных.

**Хуки:** нет (в SSR возможен `onServerPrefetch`, но он обычно скрыт внутри `useAsyncData`/`useFetch`).

**Для чего:**
- Получить данные на сервере:
  - `useAsyncData`/`useFetch` делают запросы,
  - Результат `useAsyncData` и `useFetch` сериализуется в `window.__NUXT__` (payload) и встраивается в HTML как `<script>` тег. Это позволяет избежать повторных запросов при гидратации.
- Сформировать финальный HTML и `<head>`.
- Рассмотрите возможность использования `transform` опции в `useAsyncData` для оптимизации данных перед сериализацией.

**Как понять успех/ошибку без логов:**
- **успех:** в Source/Network виден готовый HTML; в исходнике — объект `payload` (Nuxt «данные страницы»), а в Network нет повторных HTTP для этих данных при первом заходе;
- **ошибка:** 500, либо страница ошибок; типично — падение в хендлере данных (таймаут/исключение).

**Текст лога:** `[S5] INDEX.VUE SETUP (SERVER) — Выполнение setup страницы на сервере`

---

### Браузерные этапы (клиент)

#### C1. Инициализация клиентского плагина `app/plugins/app.client.ts` и `app:created`

**Слой:** Nuxt (клиент)  
**Файл:** `nuxt-app/app/plugins/app.client.ts`  
**Когда:** один раз при загрузке приложения в браузере; `app:created` — в конце этого этапа.

**Хуки:** `app:created` (конец этапа), далее этот плагин подписывает: `page:start`, `page:finish`, `app:beforeMount`, `app:mounted`.

**Для чего:**
- Инициализация только-клиентских вещей:
  - аналитика/трекинг,
  - Подписка на хуки жизненного цикла Nuxt с использованием `nuxtApp.hook()`. Это позволяет перехватывать и изменять поведение Nuxt на разных этапах.
  - глобальные клиентские настройки.
- Пример использования: инициализация service worker, настройка клиентского хранилища (localStorage, sessionStorage).

**Важно:** Плагины выполняются в порядке их объявления в `nuxt.config.ts` или алфавитном порядке файлов в директории `plugins/`.

**Как понять успех/ошибку без логов:**
- **успех:** приложение начинает жить, дальше идут C2…;
- **ошибка:** в консоли браузера — ошибка исполнения плагина, страница может остаться «без интерактива».

**Текст лога:** `[C1] CLIENT PLUGIN — Инициализация клиентского плагина и хук app:created`

---

#### C2. Глобальное route-middleware (клиент) в `app/middleware/trace.global.ts`

**Слой:** Nuxt (клиент)  
**Файл:** `nuxt-app/app/middleware/trace.global.ts`  
**Когда:** перед первичной клиентской инициализацией маршрута и перед каждой дальнейшей навигацией. (На сервере уже было — см. S3.)

**Хуки:** нет.

**Для чего:**
- Те же проверки/редиректы, но без перезагрузки страницы:
  - `navigateTo()` выполняет клиентский редирект без перезагрузки страницы. Важно учитывать, что middleware выполняется перед каждой навигацией, поэтому избегайте тяжелых операций.
  - аналитика переходов на клиенте.
- Реализация клиентской аналитики (отправка событий в Google Analytics, Yandex Metrika).

**Как понять успех/ошибку без логов:**
- **успех:** переход продолжается без полной перезагрузки;
- **редирект:** URL меняется мгновенно, запроса HTML к серверу нет (SPA-навигация).

**Текст лога:** `[C2] ROUTE MIDDLEWARE (CLIENT) — Проверка маршрута перед клиентской навигацией`

---

#### C3. Nuxt-хук `page:start` (клиентский плагин)

**Слой:** Nuxt (клиент)  
**Файл:** `nuxt-app/app/plugins/app.client.ts` (подписка)  
**Когда:** в начале клиентской навигации/инициализации страницы.

**Хуки:** `page:start` (сам этот хук).

**Для чего:**
- Управление UX во время перехода:
  - показать лоадер/прогресс,
  - старт таймеров/метрик,
  - отмена операций прошлого маршрута.
- Использование NProgress или других библиотек для отображения прогресса загрузки страницы.

**Как понять успех/ошибку без логов:**
- **успех:** видишь ожидаемое поведение (лоадер и т.п.); при ошибке — появится error-страница/тост и переход не завершится.

**Текст лога:** `[C3] Nuxt Hook page:start — Начало клиентской навигации/инициализации`

---

#### C4. Nuxt-хук `page:finish` (клиентский плагин)

**Слой:** Nuxt (клиент)  
**Файл:** `nuxt-app/app/plugins/app.client.ts` (подписка)  
**Когда:** в конце инициализации страницы с точки зрения Nuxt (переход завершён).

**Хуки:** `page:finish` (сам этот хук).

**Для чего:**
- Закрыть лоадер, зафиксировать метрики, обновить заголовки/аналитику.
- Сброс состояния глобальных индикаторов загрузки, очистка таймеров.

**Как понять успех/ошибку без логов:**
- **успех:** лоадер скрыт, страница в ожидаемом состоянии;
- **ошибка:** `page:finish` может не наступить при необработанной ошибке в навигации.

**Текст лога:** `[C4] Nuxt Hook page:finish — Конец инициализации страницы`

---

#### C5. Nuxt-хук `app:beforeMount` (клиентский плагин)

**Слой:** Nuxt (клиент)  
**Файл:** `nuxt-app/app/plugins/app.client.ts` (подписка)  
**Когда:** перед началом гидрации Vue (прямо перед монтированием корня).

**Хуки:** `app:beforeMount` (сам этот хук).

**Для чего:**
- Финальная подготовка «перед гидрацией»:
  - включить профайлеры,
  - подготовить глобальные слушатели и т.п.
- Регистрация глобальных компонентов, настройка плагинов Vue.

**Как понять успех/ошибку без логов:**
- **успех:** далее следует реальная гидрация/монтаж (см. C6+);
- **ошибка:** крайне редко; обычно это ошибки в самом коде хука.

**Текст лога:** `[C5] Nuxt Hook app:beforeMount — Перед началом гидрации Vue`

---

#### C6. Выполнение на клиенте `setup` корневого компонента `app/app.vue`

**Слой:** Vue (клиент)  
**Файл:** `nuxt-app/app/app.vue`  
**Когда:** в начале процесса гидрации корня.

**Хуки:** нет (здесь именно `setup`; следующий жизненный хук — C7).

**Для чего:**
- Создать реактивный граф на клиенте и «подвязать» его к уже существующему SSR-HTML,
- Подготовить `provide`/состояние для дочерних компонентов.

**Как понять успех/ошибку без логов:**
- **успех:** переход к C7; Отсутствие "прыжков" в интерфейсе и ошибок hydration mismatch указывает на успешную гидратацию. Ошибки могут возникнуть из-за различий в HTML, сгенерированном сервером и клиентом.
- **ошибка:** в консоли — hydration mismatch/исключения; интерактивность не появляется.
- Использование `<ClientOnly>` компонента для оборачивания компонентов, которые должны рендериться только на клиенте.

**Текст лога:** `[C6] APP.VUE SETUP (CLIENT) — Выполнение setup корня при гидрации`

---

#### C7. `onBeforeMount` у `app/app.vue` (корень)

**Слой:** Vue (клиент)  
**Файл:** `nuxt-app/app/app.vue`  
**Когда:** перед фактическим монтированием/гидрацией DOM для корня.

**Хуки:** `onBeforeMount` (корень).

**Для чего:** подготовка действий, которым ещё не нужен смонтированный DOM. Здесь можно выполнить действия, которые необходимо выполнить до монтирования корневого компонента, но после завершения гидратации.

**Как понять успех/ошибку без логов:** ожидаемо следует C8 и далее C9–C12; при ошибке — падение гидрации.

**Текст лога:** `[C7] APP.VUE onBeforeMount — Перед монтированием/гидрацией корня`

---

#### C8. Выполнение на клиенте `setup` страницы `app/pages/index.vue`

**Слой:** Vue (клиент)  
**Файл:** `nuxt-app/app/pages/index.vue`  
**Когда:** во время гидрации/инициализации страничного компонента.

**Хуки:** нет (`setup` страницы; её lifecycle — C10/C12).

**Для чего:**
- Активировать реактивность страницы; данные берутся из `payload` (повторного запроса нет),
- Настроить локальные эффекты/`watch`.
- Данные, полученные из `payload`, становятся реактивными и используются для отображения контента страницы.

**Как понять успех/ошибку без логов:**
- **успех:** контент остаётся консистентным, навешиваются обработчики;
- **ошибка:** предупреждения/ошибки hydration; клики не работают.

**Текст лога:** `[C8] INDEX.VUE SETUP (CLIENT) — Выполнение setup страницы при гидрации`

---

#### C9. Nuxt-хук `app:mounted` (клиентский плагин)

**Слой:** Nuxt (клиент)  
**Файл:** `nuxt-app/app/plugins/app.client.ts` (подписка)  
**Когда:** после завершения гидрации приложения и всех `onMounted` хуков компонентов (включая страничные компоненты).

**Хуки:** `app:mounted` (сам этот хук).

**Для чего:**
- Запуск подсистем, которым нужен реальный DOM/окно (карты, порталы, глобальные слушатели).
- Инициализация библиотек, требующих доступа к DOM (например, Leaflet, Three.js).

**Как понять успех/ошибку без логов:** страница становится интерактивной «в целом»; если что-то ломается, это уже ошибки конкретных компонентов.

**Текст лога:** `[C9] Nuxt Hook app:mounted — После завершения гидрации приложения`

---

#### C10. `onBeforeMount` у `app/pages/index.vue` (страница)

**Слой:** Vue (клиент)  
**Файл:** `nuxt-app/app/pages/index.vue`  
**Когда:** перед монтированием частей DOM, за которые отвечает страница.

**Хуки:** `onBeforeMount` (страница).

**Для чего:** подготовка действий до доступа к DOM элемента страницы. Выполнение действий, которые необходимо выполнить до монтирования компонентов страницы, но после завершения гидратации.

**Как понять успех/ошибку без логов:** ожидается C11 и C12; при ошибке — локальная деградация страницы.

**Текст лога:** `[C10] INDEX.VUE onBeforeMount — Перед монтированием DOM страницы`

---

#### C11. `onMounted` у `app/app.vue` (корень)

**Слой:** Vue (клиент)  
**Файл:** `nuxt-app/app/app.vue`  
**Когда:** после полной гидрации/монтажа корня.

**Хуки:** `onMounted` (корень).

**Для чего:** безопасная работа с DOM/Canvas/Storage на уровне приложения. Выполнение глобальных действий после монтирования корневого компонента (например, инициализация глобальных слушателей событий).

**Как понять успех/ошибку без логов:** DOM готов; глобальные виджеты/подписки должны корректно стартовать.

**Текст лога:** `[C11] APP.VUE onMounted — После полной гидрации/монтажа корня`

---

#### C12. `onMounted` у `app/pages/index.vue` (страница)

**Слой:** Vue (клиент)  
**Файл:** `nuxt-app/app/pages/index.vue`  
**Когда:** после монтирования страницы.

**Хуки:** `onMounted` (страница).

**Для чего:** инициализировать «только-клиентские» виджеты этой страницы (карта, чарт и т.п.). Инициализация компонентов страницы, требующих доступа к DOM (например, карусели, модальные окна).

**Как понять успех/ошибку без логов:** всё на странице интерактивно; если конкретный виджет не работает — смотри ошибки его инициализации.

**Текст лога:** `[C12] INDEX.VUE onMounted — После монтирования страницы`

---

### Порядок выполнения этапов

При первом заходе на страницу (SSR):

```
S1 → S2 → S3 → S4 → S5 → [HTML отправлен в браузер] → C1 → C2 → C3 → C4 → C5 → C6 → C7 → C8 → C10 → C11 → C12 → C9
```

При последующих навигациях (SPA):

```
C2 → C3 → C4 → C6 → C7 → C8 → C10 → C11 → C12 → C9
```

**Примечание:** Хук `app:mounted` (C9) срабатывает после всех `onMounted`, включая страничные компоненты.

(Этапы S1–S5 выполняются только при SSR, т.е. при первом заходе или при полной перезагрузке страницы)
